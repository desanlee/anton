<% if @target != nil then %>
	<% if current_user.lead? then %>
		<h2><%= link_to @task.name, edit_task_path(@task),:onclick=>"window.open(this.href,'create_company', 'height=600, width=600');return false;" %></h2>
	<% else %>
		<h2>"<%= @task.name %>"</h2>
	<% end %>
<% end %>

<% if @taskobjects != nil then %>
	<table class="table table-striped table-bordered table-condensed">
		<tr><td>Task Objects Name</td><td>Release Date</td><td>Finish Status </td><td></td></tr>
		<% @taskobjects.each do |t| %>
			<tr><td><%= t.device.name %></td><td><%= t.device.created_at.to_date %></td>
			<td>
				<% if t.executioncount != nil then %>
					<% (t.executioncount / 10 + 1).times do %>
						<font class="btn-small btn-success"> 
					<% end %>
					<%= t.executioncount %> Cases
				<% else %>
					<%= t.executioncount %> 0 Cases have been completed
				<% end %>
			</td>
			<td>
				<%= link_to "x", t,method: :delete, data: { confirm: "Sure?" }, class: "" %>
			</td></tr>
		<% end %>
		<% if @devices != nil and current_user == @task.user then %>
			<tr>
				<td>
					<%= form_tag controller: "tasks", action: "addtaskobject" do %>
						<%= hidden_field_tag(:selecttask, @selecttask) %>
						<%= hidden_field_tag(:selecttarget, @selecttarget) %>
						<div class="span"><%= select_tag 'taskobject', options_from_collection_for_select( @devices, :id, :name), :class => "textsize6" %></div>
						<div class="span"><%= submit_tag "+" , :class => "submit  btn " %></div>
					<% end %>
				</td><td></td><td></td>
			</tr>
		<% end %>
	</table>	
<% else %>
	<div class="alarmtext center">No test targets existed!</div>
<% end %>

<!-- Show all failed testcases -->
<% if current_user.lead? then %>
	<% failexecutions = @taskexecutions.select { |texe| texe.result == "fail" } %>
	<% if failexecutions != nil then %>
		<ul>
		<% failexecutions.uniq.each do |em| %>
			<% execution = em.execution %>
			<li><%= link_to "view", execution_path(execution),:onclick=>"window.open(this.href,'create_company', 'height=600, width=600');return false;" %>
			, <%= link_to "edit", edit_execution_path(execution),:onclick=>"window.open(this.href,'create_company', 'height=400, width=500');return false;" %>
			, <%= execution.created_at.to_date if execution != nil %>, <%= execution.testcase.name if execution.testcase != nil if execution != nil %>, by <%= execution.user.email if execution.user != nil if execution != nil %>,<%= execution.result %>, <%= execution.bug%></li>
		<% end %>
		</ul>
	<% end %>
<% end %>
<!-- Draw tables for matrixes -->

<% if @target != nil then %>
	<% if @target != nil then %>
	
<!-- Title of Matrix and Creation of new matrix -->
<hr>
	<h2>
		<div>
			<% if current_user.lead? then %>
				<%= link_to @target.name, edit_target_path(@target),:onclick=>"window.open(this.href,'create_company', 'height=600, width=600');return false;" %>
			<% else %>
				<%= @target.name %>
			<% end %>
			<% if current_user.lead? then %>
				<div class="toright">
					<%= form_tag controller: "tasks", action: "selectuser" do %>
						<%= hidden_field_tag(:selecttask, @selecttask) %>
						<%= hidden_field_tag(:selecttarget, @selecttarget) %>
						<div class="span"><%= select_tag 'selectuser', options_from_collection_for_select( @users, :id, :email, @target.user.id ) %></div>
						<div class="span"><%= submit_tag "OK" , :class => "submit btn " %></div>
					<% end %>
				</div>
			<% end %>
		</div>
	</h2>

<!-- Draw tables -->		
		<% if @targetenv != nil %>
			<% if current_user == @task.user then %>
<!-- Select X -->
				<div class="span">
				<%= form_tag controller: "tasks", action: "adddevice" do %>
					<%= hidden_field_tag(:selecttask, @selecttask) %>
					<%= hidden_field_tag(:selecttarget, @selecttarget) %>
					<%= hidden_field_tag(:selecttargetenv, @targetenv.id) %>
					<div class="span">DEVICES for X: <%= select_tag 'selectdevice', options_from_collection_for_select( @devices, :id, :longname), :class => "textsize4" if @devices != nil %></div>
					<div class="span"><%= submit_tag "+" , :class => "submit  btn " %></div>
				<% end %>
				</div>
<!-- Select Y -->
				<div class="span">
				<%= form_tag controller: "tasks", action: "addtestcase" do %>
					<%= hidden_field_tag(:selecttask, @selecttask) %>
					<%= hidden_field_tag(:selecttarget, @selecttarget) %>
					<%= hidden_field_tag(:selecttargetenv, @targetenv.id) %>
					<div class="span">TESTCASE for Y: <%= select_tag 'selecttestcase', options_from_collection_for_select( @testcases, :id, :longname), :class => "textsize4"  %></div>
					<div class="span"><%= submit_tag "+" , :class => "submit  btn " %></div>
				<% end %>
				</div>
<!-- Select Env -->
				<div class="span">
					<%= form_tag controller: "tasks", action: "adddepdevice" do %>
						<%= hidden_field_tag(:selecttask, @selecttask) %>
						<%= hidden_field_tag(:selecttarget, @selecttarget) %>
						<%= hidden_field_tag(:selecttargetenv, @targetenv.id) %>
						<div class="span">SHOW ENVIRONMENT: <%= select_tag 'selectdevice', options_from_collection_for_select( @devices, :id, :longname), :class => "textsize4"  %></div>
						<div class="span"><%= submit_tag "+" , :class => "submit  btn " %></div>
					<% end %>
				</div>
			<% end %>
			<table class="table table-bordered table-condensed">
				<% @colum = 0 %>
				<tr>
<!-- First line is testcase list -->
					<td>Devices Under Test</td>
					<% depexist = false %>
					<% if @envdepdevices != nil then%>
						<% depexist = true if @envdepdevices.count > 0 %>
						<td>Test Environment</td>
					<% end %>
					<% @envtestcases.each do |c| %>
						<td>
							<% if current_user.lead? then %>
								<%= link_to c.testcase.name, c, :selecttask => @task.id, :selecttarget => @target.id,method: :delete, data: { confirm: "Sure?" }, class: "" %>
							<% else %>
								<%= c.testcase.name %>
							<% end %>
						</td>
						<% @colum = @colum + 1 %>
					<% end %>
				</tr>
<!-- Draw each lines -->				
				<% @envdevices.each do |d| %>
					<tr>
	<!-- The first row -->
						<td>
							<% if current_user.lead? then %>
								<%= link_to d.device.name, d, method: :delete, data: { confirm: "Sure?" }, class: "" %>
							<% else %>
								<%= d.device.name %>
							<% end %>
						</td>
						
						<td></td> 
						<% @envtestcases.each do |c| %>
							<td>
	<!-- test total result will be filled here, a new line -->
							</td>
						<% end %>
					</tr>
<!-- test environment result, if there're any,  will be filled here -->
					<% if depexist == true then %>  
						<% @envdepdevices.each do |dep| %>
							<tr><td></td>
								<td>
								<% if dep.device != nil then %>
									<% if current_user.lead? then %>
										<%= link_to dep.device.name, dep, method: :delete, data: { confirm: "Sure?" }, class: "" %></td>
									<% else %>
										<%= dep.device.name %>
									<% end %>
								<% end %>
								<% @envtestcases.each do |c| %>
									<td>
										<% currentexecutions = @thematrix.select { |mx| mx.device_id == d.device_id and mx.envdevice_id == dep.device_id and mx.testcase_id == c.testcase_id } %>
										<% if currentexecutions.count != 0 then %>
											<% currentexecutions.each do |em| %>
												<% if em.execution != nil then %>
													<font onmouseover="ShowContent('<%= em.execution.id %>');" onmouseout="HideContent('<%= em.execution.id %>');">
														<% if em.execution.result == "fail" then %>
															<%= link_to ' x ', execution_path(em.execution),:onclick=>"window.open(this.href,'create_company', 'height=600, width=600');return false;", :class => "btn-mini btn-danger"  %>(cr:<%=em.execution.bug%>)
														<% else %>
															<%= link_to " v ", execution_path(em.execution),:onclick=>"window.open(this.href,'create_company', 'height=600, width=600');return false;", :class => "btn-mini btn-success" %>
														<% end %>
													</font>
												<% end %>
											<% end %>
										<% end %>
									</td>
								<% end %>
							</tr>
						<% end %>
					<% end %>
				<% end %>		
			</table>
		<% end %>
	<% else %>
			<div class="alarmtext center">Select A target first!</div>
	<% end %>
<% end %>
